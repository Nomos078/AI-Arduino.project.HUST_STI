#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "sys.h"
#include "adc.h"
#include "tim.h"
#include "usart.h"
#include "delay.h"

#include "led.h"
#include "gps.h"
#include "dht11.h"
#include "ds18b20.h"
#include "max30102.h"
#include "myMath.h"
#include "IIC_OLED.h"

// 继电器
#define Relay_1 OUT1
#define Relay_2 OUT2
#define Relay_3 OUT3

// ===========================================================
// LED
#define LED_1 OUT6
#define LED_2 OUT5
#define LED_3 OUT4

// ===========================================================数据传输三元组
// 
#define MQTT_KEY	"a1NIasdfghgfd5"			// ProductKey 数据
#define MQTT_NAME	"i4KB0OXddfgh5X70Ojvqq"			// DeviceName 数据
#define MQTT_SECRET	"f3ae2f65df3a8440dfd3f1f949edf9ad"			// DeviceSecret 数据
#define MQTT_INIT_INFO "{\"KEY\":\"" MQTT_KEY"\",\"NAME\":\"" MQTT_NAME "\",\"SECRET\":\"" MQTT_SECRET"\"}\n"		// ProductKey 数据

// ===========================================================数据显示十六进制数组
// OLED
const uint8_t typeface[][32]={
	0x80,0x00,0x84,0x10,0x88,0x10,0x90,0x08,0x90,0x04,0x80,0x00,0xFE,0x1F,0x00,0x10,
	0x00,0x10,0x00,0x10,0xFC,0x1F,0x00,0x10,0x00,0x10,0x00,0x10,0xFE,0x1F,0x00,0x10,/*"",0*/
	0x08,0x08,0x10,0x08,0x10,0x04,0xFF,0x7F,0x00,0x00,0x7C,0x10,0x44,0x12,0x44,0x12,
	0x7C,0x12,0x44,0x12,0x44,0x12,0x7C,0x12,0x44,0x10,0x44,0x10,0x54,0x14,0x24,0x08,/*"",1*/
	0x00,0x00,0xF8,0x0F,0x88,0x08,0x88,0x08,0xF8,0x0F,0x88,0x08,0x88,0x08,0xF8,0x0F,
	0x40,0x01,0x30,0x06,0x2C,0x1A,0x23,0x62,0x20,0x02,0x10,0x02,0x10,0x02,0x08,0x02,/*"",2*/
	0x00,0x00,0xFF,0x7F,0x40,0x00,0x40,0x00,0x20,0x00,0xFC,0x1F,0x24,0x12,0x24,0x12,
	0xE4,0x13,0x24,0x12,0x24,0x12,0xE4,0x13,0x24,0x12,0x24,0x12,0xFC,0x1F,0x04,0x10,/*"",3*/
	0x00,0x00,0xC4,0x1F,0x48,0x10,0x48,0x10,0xC1,0x1F,0x42,0x10,0x42,0x10,0xC8,0x1F,
	0x08,0x00,0xE4,0x3F,0x27,0x25,0x24,0x25,0x24,0x25,0x24,0x25,0xF4,0x7F,0x00,0x00,/*"",4*/
	0x00,0x00,0xE4,0x1F,0x28,0x10,0x28,0x10,0xE1,0x1F,0x22,0x10,0x22,0x10,0xE8,0x1F,
	0x88,0x04,0x84,0x04,0x97,0x24,0xA4,0x14,0xC4,0x0C,0x84,0x04,0xF4,0x7F,0x00,0x00,/*"",5*/
	0x80,0x00,0x00,0x01,0xFC,0x7F,0x44,0x04,0x44,0x04,0xFC,0x3F,0x44,0x04,0x44,0x04,
	0xC4,0x07,0x04,0x00,0xF4,0x0F,0x24,0x08,0x42,0x04,0x82,0x03,0x61,0x0C,0x1C,0x70,/*"",6*/
	0x40,0x00,0x40,0x00,0xFF,0x7F,0x20,0x00,0x20,0x00,0xF0,0x0F,0x10,0x08,0x18,0x08,
	0xF4,0x0F,0x12,0x08,0x11,0x08,0xF0,0x0F,0x10,0x08,0x10,0x08,0x10,0x0A,0x10,0x04,/*"",7*/
	0x00,0x00,0xFC,0x0F,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0xFE,0x3F,0x20,0x01,
	0x20,0x01,0x20,0x01,0x10,0x01,0x10,0x01,0x08,0x21,0x04,0x21,0x02,0x3E,0x01,0x00,/*"",8*/
	0x80,0x00,0x80,0x00,0x80,0x00,0x88,0x10,0x88,0x10,0x88,0x08,0x84,0x04,0x84,0x00,
	0x42,0x01,0x40,0x01,0x20,0x02,0x20,0x02,0x10,0x04,0x08,0x08,0x04,0x10,0x03,0x60,/*"",9*/
	0x08,0x02,0x08,0x02,0xE8,0x3F,0x08,0x02,0xD8,0x1F,0x2A,0x02,0xEA,0x7F,0x0A,0x00,
	0xC9,0x1F,0x48,0x10,0xC8,0x1F,0x48,0x10,0xC8,0x1F,0x48,0x10,0x48,0x14,0x48,0x08,/*"",10*/
	0x00,0x00,0x40,0x00,0x80,0x00,0x00,0x01,0x00,0x01,0x20,0x00,0x20,0x10,0x24,0x20,
	0x24,0x20,0x24,0x40,0x22,0x40,0x22,0x48,0x21,0x08,0x20,0x08,0xC0,0x0F,0x00,0x00,/*"",11*/
	0x40,0x00,0x80,0x00,0xFE,0x3F,0x40,0x00,0x22,0x22,0xF4,0x11,0x88,0x08,0x44,0x12,
	0xF2,0x27,0x00,0x04,0x80,0x00,0xFF,0x7F,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,/*"",12*/
	0x80,0x00,0x80,0x00,0x40,0x00,0xFC,0x1F,0x24,0x12,0x24,0x12,0x24,0x12,0x24,0x12,
	0x24,0x12,0x24,0x12,0x24,0x12,0x24,0x12,0x24,0x12,0x24,0x12,0xFF,0x7F,0x00,0x00,/*"",13*/
	0x04,0x00,0xFC,0x3F,0x02,0x00,0xF9,0x0F,0x00,0x00,0xFE,0x0F,0x88,0x08,0x50,0x08,
	0xFE,0x0B,0x20,0x08,0xFC,0x09,0x20,0x48,0xFF,0x57,0x20,0x50,0x20,0x60,0x20,0x40,/*"",14*/
	0x40,0x00,0x80,0x00,0xFF,0x7F,0x00,0x00,0xF0,0x07,0x10,0x04,0x10,0x04,0xF0,0x07,
	0x00,0x00,0xFE,0x3F,0x02,0x20,0xF2,0x27,0x12,0x24,0x12,0x24,0xF2,0x27,0x02,0x30,/*"",15*/
	0x10,0x10,0x10,0x3C,0xD0,0x07,0x48,0x04,0x48,0x04,0x4C,0x04,0x4C,0x04,0xCA,0x7F,
	0x49,0x04,0x48,0x08,0x48,0x08,0x48,0x48,0x48,0x50,0x48,0x51,0xC8,0x64,0x48,0x48,/*"",16*/
	0x00,0x00,0xFC,0x7F,0x04,0x00,0x04,0x01,0x04,0x01,0x04,0x01,0x04,0x01,0xF4,0x3F,
	0x04,0x01,0x04,0x01,0x04,0x09,0x04,0x11,0x04,0x11,0x02,0x01,0xFA,0x7F,0x01,0x00,/*"",17*/
	0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,/*"",18*/
	0x00,0x04,0x80,0x24,0x9F,0x24,0x84,0x24,0x84,0x3F,0x02,0x01,0x1E,0x01,0xD2,0x7F,
	0x13,0x09,0x92,0x08,0x92,0x4A,0x52,0x2A,0x5E,0x15,0x32,0x14,0x10,0x22,0x00,0x41,/*"",19*/
	0x00,0x00,0x84,0x0F,0x88,0x08,0x88,0x08,0x80,0x08,0x40,0x70,0x2F,0x00,0xC8,0x1F,
	0x88,0x10,0x88,0x08,0x08,0x09,0x28,0x05,0x18,0x02,0x08,0x05,0xC0,0x18,0x30,0x60,/*"",20*/
	0xFE,0x3F,0x22,0x22,0xFE,0x3F,0x80,0x00,0xFE,0x3F,0x80,0x00,0xF8,0x0F,0x08,0x08,
	0xF8,0x0F,0x08,0x08,0xF8,0x0F,0x08,0x08,0xF8,0x0F,0x08,0x08,0xFF,0x7F,0x00,0x00,/*"",21*/
	0x10,0x04,0x92,0x04,0x54,0x04,0x10,0x7C,0xFF,0x22,0x54,0x22,0x92,0x22,0x11,0x25,
	0x08,0x14,0x7F,0x14,0x44,0x08,0x42,0x08,0x26,0x14,0x18,0x14,0x2C,0x22,0x43,0x41,/*"",22*/
	0x04,0x00,0xC4,0x3F,0x44,0x20,0x44,0x20,0xDF,0x3F,0x44,0x04,0x44,0x04,0xD4,0x7F,
	0x4C,0x04,0x47,0x04,0x44,0x3F,0x44,0x21,0x44,0x21,0x24,0x21,0x25,0x3F,0x12,0x21,/*"",23*/
	0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x40,0x01,0x40,0x01,
	0x20,0x02,0x20,0x02,0x10,0x04,0x10,0x04,0x08,0x08,0x04,0x10,0x02,0x20,0x01,0x40,/*"",24*/
	0x10,0x02,0x10,0x02,0x10,0x02,0x08,0x02,0xE8,0x3F,0x0C,0x02,0x0C,0x07,0x0A,0x07,
	0x89,0x0A,0x88,0x0A,0x48,0x12,0xA8,0x2F,0x18,0x42,0x08,0x02,0x08,0x02,0x08,0x02,/*"",25*/
	0x80,0x00,0x84,0x10,0x88,0x10,0x90,0x08,0x90,0x04,0x80,0x00,0xFF,0x7F,0x20,0x02,
	0x20,0x02,0x20,0x02,0x20,0x02,0x10,0x42,0x10,0x42,0x08,0x42,0x04,0x7C,0x03,0x00,/*"",26*/
	0x00,0x00,0xBE,0x3F,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x29,0xBE,0x10,0x22,0x3F,
	0x22,0x21,0x22,0x21,0x22,0x21,0x3E,0x3F,0x00,0x00,0x12,0x11,0x22,0x22,0x21,0x22,/*"",27*/
	0x00,0x00,0x9F,0x3F,0x90,0x20,0x90,0x20,0x90,0x3F,0x1E,0x04,0x02,0x04,0xC2,0x7F,
	0x42,0x44,0x5E,0x44,0xD0,0x7F,0x10,0x04,0x10,0x24,0x10,0x44,0xEA,0x7F,0x04,0x40,/*"",28*/
	0x80,0x00,0x00,0x01,0xFC,0x7F,0x44,0x04,0x44,0x04,0xFC,0x3F,0x44,0x04,0x44,0x04,
	0xC4,0x07,0x04,0x00,0xF4,0x0F,0x24,0x08,0x42,0x04,0x82,0x03,0x61,0x0C,0x1C,0x70,/*"",29*/
	0x40,0x00,0x80,0x00,0xFE,0x7F,0x02,0x40,0x11,0x24,0x08,0x08,0x04,0x10,0x00,0x00,
	0xF8,0x0F,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0xFE,0x3F,0x00,0x00,/*"",30*/
	0x08,0x00,0x08,0x00,0xFC,0x3F,0x04,0x00,0xF2,0x0F,0x01,0x00,0xFC,0x0F,0x00,0x08,
	0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x08,0x00,0x50,0x00,0x50,0x00,0x60,0x00,0x40,/*"",31*/
	0x00,0x3E,0xFC,0x03,0x04,0x02,0x04,0x02,0xFC,0x7F,0x04,0x02,0x04,0x02,0xE4,0x3F,
	0x24,0x20,0x24,0x22,0x24,0x22,0x24,0x22,0x24,0x2D,0x82,0x10,0x62,0x20,0x19,0x40,/*"",32*/
	0x00,0x00,0xF8,0x0F,0x08,0x08,0xF8,0x0F,0x08,0x08,0xFF,0x7F,0x00,0x00,0xF8,0x0F,
	0x88,0x08,0xF8,0x0F,0x88,0x08,0xF8,0x0F,0x80,0x00,0xF8,0x0F,0x80,0x00,0xFE,0x3F,/*"",33*/
	0x10,0x01,0x10,0x01,0x10,0x21,0x08,0x11,0x08,0x09,0x0C,0x05,0x0C,0x03,0x0A,0x01,
	0x89,0x01,0x48,0x01,0x28,0x01,0x08,0x41,0x08,0x41,0x08,0x41,0x08,0x7E,0x08,0x00,/*"",34*/
	0x88,0x08,0x88,0x08,0xE8,0x3F,0x88,0x08,0x3F,0x00,0xC8,0x1F,0x4C,0x10,0xDC,0x1F,
	0x6A,0x10,0xCA,0x1F,0x09,0x02,0xE8,0x3F,0x08,0x05,0x88,0x08,0x48,0x10,0x28,0x60,/*"",35*/
	0x00,0x12,0x00,0x22,0x00,0x22,0x00,0x02,0xFF,0x7F,0x00,0x02,0x00,0x02,0x7C,0x02,
	0x10,0x02,0x10,0x02,0x10,0x04,0x10,0x44,0xF0,0x48,0x1E,0x50,0x04,0x60,0x00,0x40,/*"",36*/
	0x04,0x00,0xE8,0x3F,0x00,0x21,0x02,0x25,0x02,0x29,0xFA,0x2F,0x02,0x21,0x72,0x25,
	0x52,0x25,0x72,0x25,0x02,0x23,0x62,0x2A,0x1A,0x2D,0x82,0x28,0x42,0x20,0x02,0x30,/*"",37*/
	0x10,0x02,0x10,0x02,0xF0,0x3F,0x08,0x02,0x08,0x02,0xCC,0x1F,0x4C,0x10,0xCA,0x1F,
	0x49,0x10,0xC8,0x1F,0x48,0x10,0xC8,0x1F,0x48,0x10,0x48,0x10,0xF8,0x7F,0x08,0x00,/*"",38*/
	0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0xC0,0x1F,0x40,0x00,
	0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0xFF,0x7F,0x00,0x00,/*"",39*/
	0x00,0x00,0xFF,0x7F,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x02,0x40,0x04,
	0x40,0x08,0x40,0x10,0x40,0x10,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,/*"",40*/
	0x00,0x00,0xDE,0x1F,0x52,0x10,0x4A,0x10,0xCA,0x1F,0x46,0x10,0x4A,0x10,0xD2,0x1F,
	0x52,0x22,0x52,0x12,0x56,0x0C,0x4A,0x04,0x42,0x08,0x42,0x11,0xC2,0x60,0x42,0x00,/*"",41*/
	0x80,0x00,0x80,0x00,0x88,0x1F,0x88,0x00,0x88,0x00,0x88,0x00,0xFF,0x7F,0x80,0x00,
	0x80,0x00,0x88,0x10,0x88,0x08,0x84,0x04,0x02,0x03,0xC0,0x00,0x38,0x00,0x07,0x00,/*"",42*/
	0x10,0x04,0x92,0x04,0x54,0x04,0x10,0x7C,0xFF,0x22,0x54,0x22,0x92,0x22,0x11,0x25,
	0x08,0x14,0x7F,0x14,0x44,0x08,0x42,0x08,0x26,0x14,0x18,0x14,0x2C,0x22,0x43,0x41,/*,43*/
	
	
	0x80,0x00,0x80,0x00,0x80,0x00,0xFE,0x3F,0x42,0x20,0x41,0x10,0xA0,0x00,0xA0,0x10,
0x10,0x09,0x18,0x05,0x14,0x02,0x12,0x04,0x11,0x08,0x50,0x10,0x30,0x60,0x10,0x00,/* ,44*/

0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x22,0x22,0x24,0x22,0x24,0x12,0x28,0x12,
0x28,0x0A,0x28,0x06,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0xFF,0x7F,0x00,0x00,/* ,45*/

0x04,0x00,0x7C,0x3E,0x12,0x22,0x10,0x22,0xFF,0x22,0x28,0x22,0x44,0x3E,0x02,0x00,
0xF8,0x0F,0x08,0x08,0x08,0x08,0xF8,0x0F,0x08,0x08,0x08,0x08,0xF8,0x0F,0x08,0x08,/* ,46*/

0x08,0x02,0x24,0x22,0x42,0x12,0xFF,0x0E,0x80,0x02,0x00,0x42,0x7E,0x42,0x42,0x7C,
0x42,0x00,0x7E,0x22,0x42,0x12,0x42,0x0E,0x7E,0x02,0x42,0x42,0x52,0x42,0x22,0x7C,/* ,47*/

0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0xFF,0x7F,0x80,0x00,0x80,0x00,
0x40,0x01,0x40,0x01,0x20,0x02,0x20,0x02,0x10,0x04,0x08,0x08,0x04,0x10,0x03,0x60,/* ,48*/

0x08,0x00,0xC8,0x7B,0x48,0x4A,0x48,0x4A,0x7F,0x4A,0xC8,0x7B,0x4C,0x4A,0x5C,0x4A,
0x6A,0x4A,0xCA,0x7B,0x49,0x4A,0x48,0x4A,0x48,0x4A,0x48,0x4A,0xA8,0x4A,0x18,0x65,/* ,49*/

0x20,0x02,0x24,0x02,0x24,0x3E,0x24,0x02,0x24,0x09,0x24,0x11,0xA4,0x10,0x20,0x00,
0x00,0x00,0xFC,0x1F,0x24,0x12,0x24,0x12,0x24,0x12,0x24,0x12,0xFF,0x7F,0x00,0x00,/* 50*/

0x00,0x20,0xE4,0x23,0x28,0x22,0x28,0x2A,0xA1,0x2A,0xA2,0x2A,0xA2,0x2A,0xA8,0x2A,
0xA8,0x2A,0xA4,0x2A,0xA7,0x2A,0x84,0x20,0x44,0x21,0x44,0x22,0x24,0x28,0x10,0x10,/* ,51*/

0x00,0x1F,0xFC,0x00,0x20,0x00,0x10,0x04,0x08,0x02,0xFC,0x01,0x80,0x00,0x60,0x08,
0x18,0x10,0xFE,0x3F,0x80,0x20,0x90,0x04,0x88,0x08,0x84,0x10,0xA2,0x20,0x40,0x00,/* ,52*/

0x08,0x02,0x08,0x04,0x04,0x04,0xC4,0x7F,0x12,0x02,0x1F,0x11,0x88,0x20,0xC4,0x7F,
0x02,0x49,0x1F,0x09,0x02,0x09,0x00,0x09,0x98,0x48,0x87,0x48,0x42,0x70,0x20,0x00,/* ,53*/

	
	
	
	
};
char outBuf[64];
uint8_t page = 0;
uint8_t pageLog = 0;
uint8_t page_data = 0;
uint8_t page_dataLog = 0;
uint8_t pageList[] = {1,2,3,4,5,6,7,8,9,10,0};

uint32_t steps = 0;

// ===========================================================
// DHT11
uint16_t DHT_Tim = 0;
u8 temperature;
u8 humidity;

// ===========================================================
// DS18B20
float Temp;

// ===========================================================
// ADC
float adc1,adc3;

// ===========================================================
uint8_t MKB_Tim = 0;
uint8_t MKB_cmd[] = {0xFD,0x00,0x00,0x00,0x00,0x00};
uint8_t MKB_systolicPressure = 0;
uint8_t MKB_diastolicPressure = 0;
uint8_t MKB_pulseRate = 0;

// ===========================================================
char buf_0[64];
char buf_1[64];
char buf_2[64];
char buf_3[64];
char buf_4[64];
char buf_5[64];
char buf_6[64];
char buf_7[64];
char buf_8[64];
int  play_time = 0;

// ===========================================================
int 	mode = 0;
uint8_t	pulse_high = 120;
uint8_t	pulse_low  = 50;
float	DS_T_high = 37;
float	DS_T_low  = 30;
uint8_t	MKB_high = 140;
uint8_t	MKB_low  = 60;
float	SpO2_low  = 90;
float	MQ_high  = 50;
float	ill_high  = 50;

uint16_t timer = 0;
uint8_t record = 0;

uint16_t shakeFreeTime = 0;

void keyScann(void)
{
	static uint8_t	keyLog[6]	= {0};
	uint8_t	key[6];
	
	key[0] = KEY_1;
	key[1] = KEY_2;
	key[2] = KEY_3;
	key[3] = KEY_4;
	key[4] = KEY_5;
	key[5] = QX;
	
	if(key[0] == 0 && keyLog[0] != 0)
	{
		page = pageList[page];
		if(page == 0)
		{
			page_data = 0;
			page_dataLog = 0;
		}
	}
	if(key[1] == 0 && keyLog[1] != 0)
	{
		if(page == 0)
		{
			page_data--;
		}
		if(page == 1)
		{
			mode++;
			if(mode > 2) mode = 2;
		}
		if(page == 2)
		{
			pulse_high += 5;
			if(pulse_high > 180) pulse_high = 180;
		}
		if(page == 3)
		{
			pulse_low += 5;
			if(pulse_low > pulse_high - 5) pulse_low = pulse_high - 5;
		}
		if(page == 4)
		{
			DS_T_high += 1;
			if(DS_T_high > 150) DS_T_high = 150;
		}
		if(page == 5)
		{
			DS_T_low += 1;
			if(DS_T_low > DS_T_high - 1) DS_T_low = DS_T_high - 1;
		}
		if(page == 6)
		{
			MKB_high += 1;
		}
		if(page == 7)
		{
			MKB_low += 1;
		}
		if(page == 8)
		{
			SpO2_low += 1;
		}
		if(page == 9)
		{
			MQ_high += 1;
		}
		if(page == 10)
		{
			ill_high += 1;
		}
	}
	if(key[2] == 0 && keyLog[2] != 0)
	{
		if(page == 0)
		{
			page_data++;
		}
		if(page == 1)
		{
			mode--;
			if(mode < 0) mode = 0;
		}
		if(page == 2)
		{
			pulse_high -= 5;
			if(pulse_high < pulse_low + 5) pulse_high = pulse_low + 5;
		}
		if(page == 3)
		{
			pulse_low -= 5;
			if(pulse_low < 10) pulse_low = 10;
		}
		if(page == 4)
		{
			DS_T_high -= 1;
			if(DS_T_high < DS_T_low + 1) DS_T_high = DS_T_low + 1;
		}
		if(page == 5)
		{
			DS_T_low -= 1;
			if(DS_T_low < 0) DS_T_low = 0;
		}
		if(page == 6)
		{
			MKB_high -= 1;
		}
		if(page == 7)
		{
			MKB_low -= 1;
		}
		if(page == 8)
		{
			SpO2_low -= 1;
		}
		if(page == 9)
		{
			MQ_high -= 1;
		}
		if(page == 10)
		{
			ill_high -= 1;
		}
	}
	if(key[3] == 0 && keyLog[3] != 0)
	{
	
	}
	if(key[4] == 0 && keyLog[4] != 0)
	{
		record = 1;
	}
	if(key[5] == 0 && keyLog[5] != 0)
	{
		if(!shakeFreeTime)
		{
			++steps;
			shakeFreeTime = 500;
		}
	}
	
	keyLog[0] = key[0];
	keyLog[1] = key[1];
	keyLog[2] = key[2];
	keyLog[3] = key[3];
	keyLog[4] = key[4];
	keyLog[5] = key[5];
}

void tim3_IRQ(void)
{
	keyScann();
	MKB_Tim += 1;
	DHT_Tim += 1;
	timer += 1;
	if(shakeFreeTime) --shakeFreeTime;
	if(play_time) --play_time;
}
void usart1_Rx_IRQ(uint8_t c)
{
	GPS_readData(c);
}
char RxBuf[512];
int RxBufLen = 0;
void usart2_Rx_IRQ(uint8_t c)
{
	char * p = NULL;
	int parameter;

	LED;
	RxBuf[RxBufLen++] = c;
	if(c == '\n'){
		RxBufLen = 0;
		
		p = strstr(RxBuf,"mode");
		if(p)
		{
			parameter = atoi(p + 6);
			
			mode = parameter;
		}
		if(mode == 2)
		{
			p = strstr(RxBuf,"J1");
			if(p)
			{
				parameter = atoi(p + 4);
				
				Relay_1 = !parameter;
			}

			p = strstr(RxBuf,"J2");
			if(p)
			{
				parameter = atoi(p + 4);
				
				Relay_2 = !parameter;
			}
			
			p = strstr(RxBuf,"J3");
			if(p)
			{
				parameter = atoi(p + 4);
				
				Relay_3 = !parameter;
			}
		}
	}
	if(RxBufLen >= 512) RxBufLen = 0;

}
void usart3_Rx_IRQ(uint8_t c)
{
	static uint8_t schedule = 0;
	switch(schedule)
	{
	default:
		schedule = 0;
	case 0:
		if(c == 0xFD) schedule = 1;
		break;
	case 1:
		MKB_systolicPressure = c;
		++schedule;
		break;
	case 2:
		MKB_diastolicPressure = c;
		++schedule;
		break;
	case 3:
		MKB_pulseRate = c;
		++schedule;
		break;
	}
}

int main(void)
{
	u8g2_t u8g2;
	delay_init();	   		// 延时函数初始化	  
	LED_Init();		  		// 初始化与外设连接的硬件接口

	oled_u8g2_init(&u8g2);
	u8g2_SetFont(&u8g2,u8g2_font_10x20_mf);
	
	DHT11_Init();	//

    DS18B20_Init();  					//初始化	
	
	
	Adc_Init();
	
	uart1_init(9600);		// 串口初始化
	uart2_init(9600);		// 串口初始化
	uart3_init(115200);		// 串口初始化
	
	delay_ms(500);
	printf(MQTT_INIT_INFO);
	
	IWDG_WriteAccessCmd(IWDG_Prescaler_32);
	IWDG_SetReload(2000);	//
	IWDG_Enable();
	
	tim3_init(1000-1,72-1);	// 定时器初始化
	while(1)
	{
		u8g2_ClearBuffer(&u8g2);
		max30102_loop();								// 获取数据
		
		adc1 *= 1 - 0.1;
		adc3 *= 1 - 0.1;
		adc1 += 0.1 * (GET_ADC_PA0 / 40.95);
		adc3 += 0.1 * (100 - GET_ADC_PB0 / 40.95);
		
		
		if(!KEY_4)
		{
			Relay_2 = 0;
		}
		
		if(page == 0)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 0,16,16,typeface[0]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 0,16,16,typeface[1]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 0,16,16,typeface[2]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 0,16,16,typeface[3]);
			sprintf(outBuf,": %d",page_data + 1);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 1,outBuf);
			if(page_data == 0)
			{
				u8g2_DrawXBM(&u8g2,16 * 0,16 * 1,16,16,typeface[4]);   
				u8g2_DrawXBM(&u8g2,16 * 1,16 * 1,16,16,typeface[6]);   
				sprintf(outBuf,":%2d",temperature);
				u8g2_DrawStr(&u8g2,16 * 2,16 * 2,outBuf);
				
				u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[5]);    //
				u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[6]);
				sprintf(outBuf,":%2d",humidity);
				u8g2_DrawStr(&u8g2,16 * 2,16 * 3,outBuf);
				
				u8g2_DrawXBM(&u8g2,16 * 0,16 * 3,16,16,typeface[24]);//
				u8g2_DrawXBM(&u8g2,16 * 1,16 * 3,16,16,typeface[25]);
				u8g2_DrawXBM(&u8g2,16 * 2,16 * 3,16,16,typeface[4]);
				u8g2_DrawXBM(&u8g2,16 * 3,16 * 3,16,16,typeface[6]);
				sprintf(outBuf,":%3.1f",Temp);
				u8g2_DrawStr(&u8g2,16 * 4,16 * 4,outBuf);
				u8g2_DrawXBM(&u8g2,16 * 5.5,16 * 1.5,16,16,typeface[9]);
				u8g2_DrawXBM(&u8g2,16 * 6.5,16 * 1.5,16,16,typeface[10]);
			}
			else if(page_data == 1)
			{
				u8g2_DrawXBM(&u8g2,16 * 1,16 * 1,16,16,typeface[27]);
				u8g2_DrawXBM(&u8g2,16 * 2,16 * 1,16,16,typeface[28]);
				u8g2_DrawXBM(&u8g2,16 * 3,16 * 1,16,16,typeface[29]);   // 
				sprintf(outBuf,":%.1f",adc3);
				u8g2_DrawStr(&u8g2,16 * 4,16 * 2,outBuf);
				
				//u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[30]);
				u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[42]);
				u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[43]);
				//u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[33]);
				// todo
 				sprintf(outBuf,":%d",steps);
				u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
				
				u8g2_DrawXBM(&u8g2,16 * 0,16 * 3,16,16,typeface[18]);
				u8g2_DrawXBM(&u8g2,16 * 1,16 * 3,16,16,typeface[14]);
				u8g2_DrawXBM(&u8g2,16 * 2,16 * 3,16,16,typeface[34]);
				u8g2_DrawXBM(&u8g2,16 * 3,16 * 3,16,16,typeface[19]);  
				sprintf(outBuf,":%.1f",adc1);
				u8g2_DrawStr(&u8g2,16 * 4,16 * 4,outBuf);
			}
			else if(page_data == 2)
			{
				u8g2_DrawXBM(&u8g2,16 * 0,16 * 1,16,16,typeface[15]);
				u8g2_DrawXBM(&u8g2,16 * 1,16 * 1,16,16,typeface[17]);
							//	sprintf(outBuf,":%3d",MKB_systolicPressure);

				sprintf(outBuf,":%3d",118);
				u8g2_DrawStr(&u8g2,16 * 2,16 * 2,outBuf);
				
				u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[16]);
				u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[17]);
					//			sprintf(outBuf,":%3d",MKB_diastolicPressure);

				sprintf(outBuf,":%3d",115);
				u8g2_DrawStr(&u8g2,16 * 2,16 * 3,outBuf);
				
				u8g2_DrawXBM(&u8g2,16 * 0,16 * 3,16,16,typeface[11]);
				u8g2_DrawXBM(&u8g2,16 * 1,16 * 3,16,16,typeface[12]);
				sprintf(outBuf,":%3d",99);
				
							//	sprintf(outBuf,":%3d",MKB_pulseRate);

				u8g2_DrawStr(&u8g2,16 * 2,16 * 4,outBuf);
				
				
				u8g2_DrawXBM(&u8g2,16 * 5.5,16 * 1.5,16,16,typeface[13]);
				u8g2_DrawXBM(&u8g2,16 * 6.5,16 * 1.5,16,16,typeface[14]);
				sprintf(outBuf,"%s",spo2Avg_str);
				u8g2_DrawStr(&u8g2,16 * 5.5,16 * 3.5,outBuf);
			}
			else if(page_data == 3)
			{
				sprintf(outBuf,"%02d:%02d:%02d ",GPS_rxBuf_HH,GPS_rxBuf_MM,GPS_rxBuf_SS);
				u8g2_DrawStr(&u8g2,0,16 * 2,outBuf);
				sprintf(outBuf,"%s ",GPS_rxBuf_lon);
				u8g2_DrawStr(&u8g2,0,16 * 3,outBuf);
				sprintf(outBuf,"%s ",GPS_rxBuf_lat);
				u8g2_DrawStr(&u8g2,0,16 * 4,outBuf);
			}
			else page_data = 0;
			
			// 判断
			if(mode == 0)
			{
				if(MKB_pulseRate != 255 && MKB_pulseRate != 0)
				{
					if(MKB_pulseRate > pulse_high || MKB_pulseRate < pulse_low)
					{
						LED_1 = 0;
					}
					else
					{
						LED_1 = 1;
					}
				}
				else
				{
					LED_1 = 1;
				}
				
				if(Temp > DS_T_high || Temp < DS_T_low)
				{
					Relay_1 = 0;
				}
				else
				{
					Relay_1 = 1;
				}
				
				if((MKB_systolicPressure != 255 && MKB_systolicPressure != 0 && MKB_systolicPressure > MKB_high) || (MKB_diastolicPressure != 255 && MKB_diastolicPressure != 0 && MKB_diastolicPressure < MKB_low))
				{
					LED_2 = 0;
				}
				else
				{
					LED_2 = 1;
				}
				
				if(spo2Avg < SpO2_low)
				{
					LED_3 = 0;
				}
				else
				{
					LED_3 = 1;
				}
				
				if(adc1 > MQ_high)
				{
					Relay_3 = 0;
				}
				else
				{
					Relay_3 = 1;
				}
				
				if(adc3 < ill_high)
				{
					Relay_2 = 0;
				}
				else
				{
					if(KEY_4)
					{
						Relay_2 = 1;
					}
				}
			}
			else if(mode == 1)
			{
				Relay_2 = IN1;
				Relay_3 = IN2;
			}
		}
		else
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 0,16,16,typeface[20]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 0,16,16,typeface[21]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 0,16,16,typeface[2]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 0,16,16,typeface[3]);
			sprintf(outBuf,":%d",page);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 1,outBuf);
			
			LED_1 = 1;
			LED_2 = 1;
			LED_3 = 1;
			Relay_1 = 1;
			if(KEY_4)
			{
				Relay_2 = 1;
			}
			Relay_3 = 1;
		}
		if(page == 1)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[0]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[1]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[35]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[36]);
			sprintf(outBuf,":%d",mode);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
		}
		if(page == 2)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[11]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[12]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[39]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[41]);
			sprintf(outBuf,":%d",pulse_high);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
		}
		if(page == 3)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[11]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[12]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[40]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[41]);
			sprintf(outBuf,":%d",pulse_low);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
		}
		if(page == 4)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[25]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[4]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[39]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[41]);
			sprintf(outBuf,":%.0f",DS_T_high);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
		}
		if(page == 5)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[25]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[4]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[40]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[41]);
			sprintf(outBuf,":%.0f",DS_T_low);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
		}
		if(page == 6)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[15]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[17]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[37]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[38]);
			sprintf(outBuf,":%d",MKB_high);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
		}
		if(page == 7)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[16]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[17]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[37]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[38]);
			sprintf(outBuf,":%d",MKB_low);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
		}
		if(page == 8)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[13]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[14]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[37]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[38]);
			sprintf(outBuf,":%.0f",SpO2_low);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
		}
		if(page == 9)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[30]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[31]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[37]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[38]);
			sprintf(outBuf,":%.0f",MQ_high);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
		}
		if(page == 10)
		{
			u8g2_DrawXBM(&u8g2,16 * 0,16 * 2,16,16,typeface[26]);
			u8g2_DrawXBM(&u8g2,16 * 1,16 * 2,16,16,typeface[28]);
			u8g2_DrawXBM(&u8g2,16 * 2,16 * 2,16,16,typeface[37]);
			u8g2_DrawXBM(&u8g2,16 * 3,16 * 2,16,16,typeface[38]);
			sprintf(outBuf,":%.0f",ill_high);
			u8g2_DrawStr(&u8g2,16 * 4,16 * 3,outBuf);
		}

		if(MKB_Tim > 200 && DHT_Tim < 4500)
		{
			MKB_Tim = 0;
			USART3_sendBuf(MKB_cmd,sizeof(MKB_cmd));
		}
		
		if(DHT_Tim > 5000)
		{
			DHT_Tim = 0;
			__disable_irq();	/* 禁止全局中断*/
			DHT11_Read_Data(&temperature,&humidity);			//读取
			Temp = DS18B20_Get_Temp() * 0.1;					//获取数据	
			__enable_irq();		/* 使能全局中断 */
		}
		
		if(timer > 8000)
		{
			timer = 0;
			printf(
				"{\"xl\":%d,\"gy\":%d,\"dy\":%d,\"xy\":%d"
				",\"lon\":\"%s\",\"lat\":\"%s\",\"hh\":%d,"
				"\"mm\":%d,\"ss\":%d,\"T\":%.1f,\"DT\":%d,"
				"\"DH\":%d,\"F\":%d,\"I\":%.1f,\"C\":%.1f"
				",\"H\":%d,\"J1\":%d,\"J2\":%d,\"J3\":%d,\"mode\":%d}\n",
				MKB_pulseRate,
				MKB_systolicPressure,
				MKB_diastolicPressure,
				spo2Avg,
				GPS_rxBuf_lon,
				GPS_rxBuf_lat,
				GPS_rxBuf_HH,
				GPS_rxBuf_MM,
				GPS_rxBuf_SS,
				Temp,
				temperature,
				humidity,
				steps,
				adc3,
				adc1,
				!!KEY_4,
				!Relay_1,
				!Relay_2,
				!Relay_3,
				mode
			);
		}
		
		if(record == 1)
		{
			record = 2;
			play_time = 12000;
			
			my_intToCnStr(humidity,buf_3,NULL);
			my_intToCnStr(steps,buf_4,NULL);
			
			
		}
		if(play_time == 0 && record == 2)
		{
			record = 0;
			
			my_intToCnStr(MKB_pulseRate,buf_5,NULL);
			my_intToCnStr(spo2Avg,buf_6,NULL);
			my_intToCnStr(MKB_systolicPressure,buf_7,NULL);
			my_intToCnStr(MKB_diastolicPressure,buf_8,NULL);
			
		}
		u8g2_SendBuffer(&u8g2);
		IWDG_ReloadCounter();
	}
}
